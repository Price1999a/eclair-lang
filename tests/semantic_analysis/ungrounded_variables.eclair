// NOTE: happy path is not tested, this is tested implicitly by running
// the compiler end-to-end in most other tests

// RUN: mkdir -p %t && sed s@TEST_DIR@%t@g %s > %t/input.test
// RUN: split-file %t/input.test %t

// RUN: %eclair compile %t/program.eclair 2> %t/top_level_facts_actual.out
// RUN: diff  %t/top_level_facts_expected.out %t/top_level_facts_actual.out

//--- program.eclair
@def edge(u32, u32) output.

edge(a, 1).
edge(2, b).
edge(c, d).
edge(e + 1, 1 + f).

//--- top_level_facts_expected.out
[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@3:6-3:7
     │
   3 │ edge(a, 1).
     • ┬────┬─────
     • │    ╰╸ The variable 'a' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'a'.
     •
     │ Hint: Use the variable 'a' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@4:9-4:10
     │
   4 │ edge(2, b).
     • ┬───────┬──
     • │       ╰╸ The variable 'b' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'b'.
     •
     │ Hint: Use the variable 'b' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@5:6-5:7
     │
   5 │ edge(c, d).
     • ┬────┬─────
     • │    ╰╸ The variable 'c' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'c'.
     •
     │ Hint: Use the variable 'c' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@5:9-5:10
     │
   5 │ edge(c, d).
     • ┬───────┬──
     • │       ╰╸ The variable 'd' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'd'.
     •
     │ Hint: Use the variable 'd' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@6:6-6:7
     │
   6 │ edge(e + 1, 1 + f).
     • ┬────┬─────────────
     • │    ╰╸ The variable 'e' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'e'.
     •
     │ Hint: Use the variable 'e' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program.eclair@6:17-6:18
     │
   6 │ edge(e + 1, 1 + f).
     • ┬───────────────┬──
     • │               ╰╸ The variable 'f' is ungrounded, meaning it is not directly bound as an argument to a relation.
     • ╰╸ This contains no clauses that refer to 'f'.
     •
     │ Hint: Use the variable 'f' as an argument in a relation.
─────╯
//--- program2.eclair

// RUN: %eclair compile %t/program2.eclair 2> %t/ungrounded_var_in_rule_actual.out
// RUN: diff -w %t/ungrounded_var_in_rule_expected.out %t/ungrounded_var_in_rule_actual.out

@def edge(u32, u32) input.
@def reachable(u32, u32) output.

reachable(x, z) :-
  edge(x, y).

reachable(a, b) :-
  edge(x, y).

//--- ungrounded_var_in_rule_expected.out
[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program2.eclair@8:14-8:15
     │
   8 │ ╭┤ reachable(x, z) :-
     • │               ┬
     • │               ╰╸ The variable 'z' is ungrounded, meaning it is not directly bound as an argument to a relation.
   9 │ ├┤   edge(x, y).
     • │
     • ╰╸ This contains no clauses that refer to 'z'.
     •
     │ Hint: Use the variable 'z' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program2.eclair@11:11-11:12
     │
  11 │ ╭┤ reachable(a, b) :-
     • │            ┬
     • │            ╰╸ The variable 'a' is ungrounded, meaning it is not directly bound as an argument to a relation.
  12 │ ├┤   edge(x, y).
     • │
     • ╰╸ This contains no clauses that refer to 'a'.
     •
     │ Hint: Use the variable 'a' as an argument in a relation.
─────╯

[error]: Ungrounded variable
     ╭──▶ TEST_DIR/program2.eclair@11:14-11:15
     │
  11 │ ╭┤ reachable(a, b) :-
     • │               ┬
     • │               ╰╸ The variable 'b' is ungrounded, meaning it is not directly bound as an argument to a relation.
  12 │ ├┤   edge(x, y).
     • │
     • ╰╸ This contains no clauses that refer to 'b'.
     •
     │ Hint: Use the variable 'b' as an argument in a relation.
─────╯
//--- program3.eclair

// RUN: %eclair compile %t/program3.eclair 2> %t/ungrounded_var_check_in_rule_body_actual.out
// RUN: diff -w %t/ungrounded_var_check_in_rule_body_expected.out %t/ungrounded_var_check_in_rule_body_actual.out

@def edge(u32, u32) input.
@def reachable(u32, u32) output.

reachable(x, z) :-
  edge(x, y),
  reachable(y, z),
  edge(a, b).

//--- ungrounded_var_check_in_rule_body_expected.out
